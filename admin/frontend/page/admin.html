<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="Description">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>数据表管理</title>
    <link rel="stylesheet" href="/assets/css/bootstrap3.4.min.css" />
    <link rel="stylesheet" href="/assets/css/my.css" />
    <script src="/assets/js/jquery.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/vue.global.js"></script>
    <script src="/assets/js/axios.min.js"></script>
    <script src="/assets/js/util.js"></script>
    <script src="/assets/js/bootbox.min.js"></script>
    <script src="/page/header.js"></script>

<body>
    <div id="header"></div>
    <div>
        <div id="app"></div>
        <template id="template">
            <div class="page-header">
                <h3>Tables</h3>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="list-group" style="height:400px;overflow-y: scroll;">
                        <template v-for="(item, i) in tables">
                            <a href="javascript:;" class="list-group-item" @click="queryTable(item)" :class="{'active' : item == table}">
                                {{item}}
                            </a>
                        </template>
                    </div>
                </div>
                <div class="col-md-9">
                    <p>Create SQL</p>
                    <textarea class="form-control" rows="5">{{createSQL}}</textarea>
                    <p>Sample Data</p>
                    <textarea class="form-control" rows="8">{{sampleData}}</textarea>
                    <div style="margin-top: 10px;">
                        <button @click="showDropTable()" class="btn btn-primary btn-sm">删除该表</button>
                    </div>
                </div>
            </div>
            <div class="page-header">
                <h3>创建 / 修改表结构</h3>
            </div>
            <textarea class="form-control" rows="10" v-model="sql" placeholder="请输入SQL"></textarea>
            <div style="margin-top: 10px;">
                <button class="btn btn-primary btn-sm" type="submit" @click="execSQL">执行SQL</button>
            </div>
            <div class="page-header">
                <h3>备注</h3>
            </div>
            <div class="well">
                <a href="/doc.html#/program/sql" target="_blank">参考消息</a>
            </div>
        </template>
    </div>
    <script>
        $(document).ready(function () {
            axios.defaults.headers.common['proxy'] = "storage";
            var vm = Vue.createApp({
                data() {
                    let list = []
                    return {
                        tables: list,
                        table : '',
                        sql: "",
                        sampleData: '',
                        createSQL: "",
                    }
                },
                template: '#template',
                async mounted() {
                    this.getTables()
                },
                methods: {
                    async execSQL() {
                        let result = await axios.post('/exec', this.sql)
                        if (result.data.code != 0) {
                            alert(result.data.message)
                        } else {
                            alert('执行成功')
                            window.location.reload()
                        }
                    },
                    async getTables() {
                        let result = await axios.post('/show_tables')
                        if (result.data.code != 0) {
                            alert(result.data.message)
                            return
                        }
                        this.tables = result.data.data

                        if (result.data.data.length > 0) {
                            this.queryTable(result.data.data[0])
                        }
                    },
                    async queryTable(table) {
                        /*
                        let result = await axios.post('/desc/' + table)
                        if (result.data.code != 0) {
                            alert(result.data.message)
                            return
                        }
                        this.tableDesc = result.data.data
                        if (result.data.data.length > 0) {
                            this.tableDescHeader = Object.keys(result.data.data[0])
                        }*/
                        this.table = table
                        let result1 = await axios.post('/show_create_table/' + table)
                        this.createSQL = result1.data.data
                        let result2 = await axios.post('/select/' + table, {
                            'limit': 3,
                        })
                        this.sampleData = JSON.stringify(result2.data.data, "\r\n")
                    },
                    showDropTable() {
                        bootbox.confirm("确认删除`" + this.table + "，无法恢复？", (result) => {
                            if (result) {
                                this.doDeleteTable(this.table)
                            }
                        })
                    },
                    async doDeleteTable(table) {
                        let result = await axios.post('/drop/' + table)
                        if(result.data.code != 0) {
                            bootbox.alert(result.data.message)
                            return
                        } else {
                            simpleReload()
                        }
                    }
                }
            })
            vm.mount('#app')
        })
    </script>
</body>

</html>